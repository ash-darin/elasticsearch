setup:
  - do:
      indices.create:
        index: test-index1
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0

  - do:
      bulk:
        refresh: true
        index: test-index1
        body:
          - index:
              _id: doc1
          - { "text": "document one" }
          - index:
              _id: doc2
          - { "text": "document two" }
          - index:
              _id: doc3
          - { "text": "document three" }
          - index:
              _id: doc4
          - { "text": "document four" }
          - index:
              _id: doc5
          - { "text": "document five" }

---
"pinned retriever basic functionality":
  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              ids: ["doc1", "doc2"]
              retriever:
                standard:
                  query:
                    match_all: {}

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }
  - match: { hits.hits.2._id: doc3 }
  - match: { hits.hits.3._id: doc4 }
  - match: { hits.hits.4._id: doc5 }

---
"pinned retriever parameter variations":
  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              docs:
                - _index: test-index1
                  _id: doc1
                - _index: test-index1
                  _id: doc2
              retriever:
                standard:
                  query:
                    match_all: {}

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }
  - match: { hits.hits.2._id: doc3 }

  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              ids: ["doc1"]
              retriever:
                standard:
                  query:
                    match_all: {}

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }

  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              docs:
                - _index: test-index1
                  _id: doc1
              retriever:
                standard:
                  query:
                    match_all: {}

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }

---
"pinned retriever with combined parameters":
  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              ids: ["doc1", "doc2"]
              retriever:
                standard:
                  query:
                    match_all: {}

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }
  - match: { hits.hits.2._id: doc3 }

  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              ids: ["doc1", "doc3"]
              retriever:
                standard:
                  query:
                    match_all: {}

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc3 }
  - match: { hits.hits.2._id: doc2 }
  - match: { hits.hits.3._id: doc4 }
  - match: { hits.hits.4._id: doc5 }

---
"pinned retriever combined with rrf":
  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              ids: ["doc1", "doc2"]
              retriever:
                rrf:
                  retrievers:
                    -
                      standard:
                        query:
                          match: {
                            text: "document one"
                          }
                    -
                      standard:
                        query:
                          match: {
                            text: "document two"
                          }

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }

---
"pinned retriever with pagination":
  - do:
      search:
        index: test-index1
        body:
          size: 1
          from: 1
          retriever:
            pinned:
              ids: ["doc1", "doc2"]
              retriever:
                standard:
                  query:
                    match_all: {}

  - match: { hits.total.value: 5 }
  - length: { hits.hits: 1 }
  - match: { hits.hits.0._id: doc2 }

---
"pinned retriever as a sub-retriever":
  - do:
      search:
        index: test-index1
        body:
          retriever:
            rrf:
              retrievers:
                -
                  standard:
                    query:
                      match_all: {}
                -
                  pinned:
                    ids: ["doc1", "doc2"]
                    retriever:
                      standard:
                        query:
                          match_all: {}

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }
  - match: { hits.hits.2._id: doc3 }

---
"pinned retriever with explicit sort on score":
  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              ids: ["doc1", "doc2"]
              retriever:
                standard:
                  query:
                    match_all: {}
                  sort: [ "_score" ]

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }
  - match: { hits.hits.2._id: doc3 }

---
"pinned retriever with rank window size":
  - skip:
      features: headers

  - do:
      headers:
        Content-Type: application/json
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              ids: ["doc1", "doc2"]
              retriever:
                standard:
                  query:
                    match_all: {}
              rank_window_size: 1

  - match: { hits.total.value: 5 }
  - length: { hits.hits: 1 }
  - match: { hits.hits.0._id: doc1 }

  - do:
      headers:
        Content-Type: application/json
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              ids: ["doc1", "doc2"]
              retriever:
                standard:
                  query:
                    match_all: {}
              rank_window_size: 10

  - match: { hits.total.value: 5 }
  - length: { hits.hits: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }
  - match: { hits.hits.2._id: doc3 }

---
"pinned retriever explanation":
  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              ids: ["doc1", "doc2"]
              retriever:
                standard:
                  query:
                    match_all: {}
          explain: true

  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.0._explanation.description: "/doc \\[\\d+\\] with an original score of \\[-?[\\d.E]+\\] is at rank \\[\\d+\\] from the following source queries\\./" }
  - match: { hits.hits.0._explanation.details.0.details.0.details.1.description: "is_pinned: true" }

  - match: { hits.hits.1._id: doc2 }
  - match: { hits.hits.1._explanation.description: "/doc \\[\\d+\\] with an original score of \\[-?[\\d.E]+\\] is at rank \\[\\d+\\] from the following source queries\\./" }
  - match: { hits.hits.1._explanation.details.0.details.0.details.1.description: "is_pinned: true" }

---
"pinned retriever with empty parameters":
  - do:
      search:
        index: test-index1
        body:
          retriever:
            pinned:
              retriever:
                standard:
                  query:
                    match_all: {}

  - match: { hits.total.value: 5 }
  - match: { hits.hits.0._id: doc1 }
  - match: { hits.hits.1._id: doc2 }
  - match: { hits.hits.2._id: doc3 }
  - match: { hits.hits.3._id: doc4 }
  - match: { hits.hits.4._id: doc5 }
